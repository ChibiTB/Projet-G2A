<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DBreeze - Accueil</title>
  <link rel="stylesheet" href="Vue/index.css" />
  <link rel="stylesheet" href="Vue/header.css" />
  <link rel="stylesheet" href="Vue/footer.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet">
</head>
<body>
  <div id="header-placeholder" role="banner"></div>

  <main id="main-content" role="main">
    <section class="hero" aria-labelledby="hero-heading">
      <div class="hero-content">
        <h1 id="hero-heading">Supervision en temps r√©el</h1>
        <p>Contr√¥lez votre environnement en un coup d'≈ìil</p>
      </div>
    </section>

    <!-- Message de bienvenue -->
    <div class="welcome-message" id="welcome-message" aria-live="polite"></div>

    <!-- Compteur de d√©cibels dynamique -->
    <section class="decibel-led" aria-labelledby="sonore-heading">
      <h3 id="sonore-heading">Niveau sonore actuel</h3>
      <div class="led-display" id="niveau-sonore" aria-live="polite">Chargement...</div>
    </section>

    <!-- Tableau de bord -->
    <section id="supervision" class="sensors-section" aria-labelledby="dashboard-heading">
      <div class="section-title">
        <h2 id="dashboard-heading">TABLEAU DE BORD</h2>
        <p class="subtitle">Tous vos capteurs en temps r√©el</p>
      </div>

      <div class="sensors-grid">
        <a href="sonore.html" class="sensor-card sound" aria-labelledby="sound-heading">
          <div class="card-content">
            <i class="fas fa-volume-up" aria-hidden="true"></i>
            <h3 id="sound-heading">Niveau Sonore</h3>
            <p>Ambiance parfaitement ma√Ætris√©e</p>
          </div>
        </a>

        <a href="luminosite.html" class="sensor-card lighting" aria-labelledby="light-heading">
          <div class="card-content">
            <i class="fas fa-lightbulb" aria-hidden="true"></i>
            <h3 id="light-heading">Luminosit√©</h3>
            <p>Une atmosph√®re unique</p>
          </div>
        </a>

        <a href="temphum.html" class="sensor-card co2" aria-labelledby="humidity-heading">
          <div class="card-content">
            <i class="fas fa-wind" aria-hidden="true"></i>
            <h3 id="humidity-heading">Humidit√© de l'air</h3>
            <p>Respirez la diff√©rence</p>
          </div>
        </a>

        <a href="temphum.html" class="sensor-card temperature" aria-labelledby="temp-heading">
          <div class="card-content">
            <i class="fas fa-temperature-high" aria-hidden="true"></i>
            <h3 id="temp-heading">Temp√©rature & Humidit√©</h3>
            <p>Confort optimal</p>
          </div>
        </a>

        <a href="#" class="sensor-card crowd" aria-labelledby="crowd-heading">
          <div class="card-content">
            <i class="fas fa-users" aria-hidden="true"></i>
            <h3 id="crowd-heading">Affluence</h3>
            <p>Gestion intelligente des espaces</p>
          </div>
        </a>

        <a href="distance.html" class="sensor-card security" aria-labelledby="security-heading">
          <div class="card-content">
            <i class="fas fa-shield-alt" aria-hidden="true"></i>
            <h3 id="security-heading">S√©curit√©</h3>
            <p>Protection continue</p>
          </div>
        </a>
      </div>
    </section>
  </main>

  <div id="footer-placeholder" role="contentinfo"></div>

  <!-- Scripts -->
  <script>
    async function includeHTML(selector, url) {
      try {
        const element = document.querySelector(selector);
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Failed to load ${url}: ${response.status} ${response.statusText}`);
        }
        
        const html = await response.text();
        element.innerHTML = html;
      } catch (error) {
        console.error(`Error including HTML from ${url}:`, error);
        document.querySelector(selector).innerHTML = `<div class="error-message">Impossible de charger le contenu. Veuillez rafra√Æchir la page.</div>`;
      }
    }

    // Load header and footer
    includeHTML("#header-placeholder", "header.html");
    includeHTML("#footer-placeholder", "footer.html");

    // Welcome message
    const params = new URLSearchParams(window.location.search);
    const prenom = params.get("prenom");
    if (prenom) {
      const welcome = document.getElementById("welcome-message");
      welcome.innerHTML = `<h2 style="text-align:center; color: var(--color-primary); margin: 3rem 0;">Bienvenue ${prenom} üëã</h2>`;
    }

    // Mise √† jour dynamique du niveau sonore avec gestion d'erreurs
    async function updateNiveauSonore() {
      try {
        const response = await fetch('get_last_sonore.php');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const valeur = data.sonore !== null ? `${data.sonore} dB` : 'N/A';
        
        const element = document.getElementById('niveau-sonore');
        element.textContent = valeur;
        
        // Add color coding based on sound level
        if (data.sonore !== null) {
          const level = parseFloat(data.sonore);
          element.className = 'led-display';
          
          if (level < 60) {
            element.classList.add('level-normal');
          } else if (level < 85) {
            element.classList.add('level-medium');
          } else {
            element.classList.add('level-high');
          }
        }
      } catch (error) {
        console.error('Erreur de r√©cup√©ration sonore :', error);
        document.getElementById('niveau-sonore').textContent = 'Erreur de connexion';
      }
    }

    // Initial update and interval
    updateNiveauSonore();
    
    // Use a more efficient interval
    const updateInterval = setInterval(updateNiveauSonore, 1000);
    
    // Clean up interval when page is hidden
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        clearInterval(updateInterval);
      } else {
        updateNiveauSonore();
        setInterval(updateNiveauSonore, 1000);
      }
    });
  </script>
</body>
</html>
